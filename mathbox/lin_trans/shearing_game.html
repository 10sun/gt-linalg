<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Shearing game</title>
  <script src="../build/mathbox-bundle.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.js"></script>
  <script src="matrices.js"></script>
  <link rel="stylesheet" href="../build/mathbox.css">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
</head>
<body>
    <header>
      <h1>Shearing game</h1>
      <section>
	<h2>Controls</h2>
	<ul>
	  <li>&larr; : shear left by <span id="left_matrix"></span> </li>
	  <li>&rarr; : shear right by <span id="right_matrix"></span></li>
	  <li>&darr; : shear down by <span id="down_matrix"></span></li>
	  <li>&uarr; : shear up by <span id="up_matrix"></span></li>
	</ul>
      </section>
      <section>
	  <h2>Objective</h2>
	  <p>Transform the parallelogram to a square.</p>
      </section>
    </header>


    <script>
     var mathbox = mathBox({
	 plugins: ['core', 'controls', 'cursor', 'mathbox'],
	 controls: {
             // Orbit controls, i.e. Euler angles, with gimbal lock
             klass: THREE.OrbitControls,

             // Trackball controls, i.e. Free quaternion rotation
             //klass: THREE.TrackballControls,
	 },
     });
     if (mathbox.fallback) throw "WebGL not supported"

     /* Makes the background white */
     var three = mathbox.three;
     three.renderer.setClearColor(new THREE.Color(0xFFFFFF), 1.0);


     // Place camera
     var camera =
	 mathbox
	     .camera({
		 proxy: false,
		 position: [0, 0, 3],
	     });

     // 2D cartesian
     var view =
	 mathbox
	     .cartesian({
		 range: [[-1, 1], [-1, 1]],
		 scale: [1, 1],
	     });


     // Calibrate focus distance for units
     mathbox.set('focus', 3);


     // The initial matrix
     var mat = new Matrix([[2, 1], [1, 1]]);

     var left = document.getElementById("left_matrix");
     var right = document.getElementById("right_matrix");
     var up = document.getElementById("up_matrix");
     var down = document.getElementById("down_matrix");
     const shear_left = Matrix.shear(-1, 'H');
     const shear_right = Matrix.shear(1, 'H');
     const shear_up = Matrix.shear(1, 'V');
     const shear_down = Matrix.shear(-1, 'V');

     shear_left.katex(left);
     shear_right.katex(right);
     shear_down.katex(down);
     shear_up.katex(up);

     // Creating data for a moving grid.
     var n = 20;
     view.area({
	 id: "grid",
	 axes: [1, 2],
	 width: n,
	 height: n,
	 channels: 2,
	 expr: function (emit, x, y, i, j, time) {
	     var vec = mat.multiply_vec(x,y);
	     emit(vec[0], vec[1]);
	 },
     });

     view.surface({
	 /* shaded: true,*/
	 points: '<',
	 fill: false,
	 lineX: true,
	 lineY: true,
	 /* width: 2,*/
	 color: "purple",
     });


     /* Applying transformations on keypresses. */
     document.onkeydown = function(e) {
	 var code = e.keyCode;

	 if (code == 37) { // LEFT ARROW
	     // shearing to the left, multiply by [[1, -1], [0, 1]] on the left
	     mat = mul(shear_left, mat)
	 }
	 else if (code == 39) { // RIGHT ARROW
	     // shearing to the right, multiply by [[1, 1], [0, 1]] on the left
	     mat = mul(shear_right, mat)
	 }
	 else if (code == 40) { // DOWN ARROW
	     // shearing down, multiply by [[1, 0], [-1, 1]] on the left
	     mat = mul(shear_down, mat)
	 }
	 else if (code == 38) { // UP ARROW
	     // shearing up, multiply by [[1, 0], [1, 1]] on the left
	     mat = mul(shear_up, mat)
	 }

     };

     document.onkeyup = function() {
	 if (mat.fixes_square()) {
	     alert('You won!');
	 }
     };
    </script>

</body>
</html>
